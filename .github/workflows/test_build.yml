name: Test Workflow
 
on:
   workflow_dispatch:  
   push:
     branches:
       - main
   pull_request:
     branches:
       - main
 
jobs:
   lint:
     runs-on: ubuntu-latest
     steps:
       - name: Checkout code
         uses: actions/checkout@v4
 
       - name: Install Python and Ruff
         run: |
           python -m pip install --upgrade pip
           pip install ruff
 
       - name: Run Ruff linter
         run: |
           ruff check .
 
   setup_and_test_system:
     runs-on: ubuntu-latest          
     steps:
       - name: Checkout code
         uses: actions/checkout@v4

       - name: Create .env file from secrets
         run: |
           echo "POSTGRES_USER=${{ secrets.POSTGRES_USER }}" >> .env
           echo "POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}" >> .env
           echo "POSTGRES_DB_AUTH=${{ secrets.POSTGRES_DB_AUTH }}" >> .env
           echo "POSTGRES_DB_UNIVERSITY=${{ secrets.POSTGRES_DB_UNIVERSITY }}" >> .env
           echo "UNIVERSITY_SERVICE_INTERNAL_URL=${{ secrets.UNIVERSITY_SERVICE_INTERNAL_URL }}" >> .env
           echo "UNIVERSITY_SERVICE_API_URL=${{ secrets.UNIVERSITY_SERVICE_API_URL }}" >> .env
           echo "AUTH_SERVICE_INTERNAL_URL=${{ secrets.AUTH_SERVICE_INTERNAL_URL }}" >> .env
           echo "AUTH_SERVICE_API_URL=${{ secrets.AUTH_SERVICE_API_URL }}" >> .env
 
       - name: Start test system with Docker Compose
         run: |
           docker compose -f docker-compose.yml up -d
 
       - name: Save Docker Compose configuration as artifact
         uses: actions/upload-artifact@v4
         with:
           name: docker-compose-logs
           path: ./docker-compose.yml
       
       - name: Healthcheck
         run: bash ./healthcheck.sh
       
       - name: Build test container
         run: docker build -f Dockerfile.tests -t test-runner .
       
       - name: Run tests in container
         run: |
           docker run --rm \
             --env-file .env \
             --network host \
             -v ${{ github.workspace }}/allure-results:/test_frame/allure-results \
             test-runner
 
       - name: Save Allure test results as artifact
         uses: actions/upload-artifact@v4
         with:
           name: allure-results
           path: allure-results
 
   generate_allure_report:
     runs-on: ubuntu-latest
     needs: setup_and_test_system
     steps:
       - name: Download Allure Results
         uses: actions/download-artifact@v4
         with:
           name: allure-results
           path: allure-results
 
       - name: Install Allure CLI
         run: |
           wget https://github.com/allure-framework/allure2/releases/download/2.16.1/allure-2.16.1.zip
           unzip allure-2.16.1.zip
           sudo mv allure-2.16.1 /opt/allure
           sudo ln -s /opt/allure/bin/allure /usr/local/bin/allure
 
       - name: Generate Allure Report
         run: |
           allure generate ./allure-results --clean -o ./allure-report
 
       - name: Deploy Allure Report to GitHub Pages
         uses: peaceiris/actions-gh-pages@v4
         with:
           github_token: ${{ secrets.GH_PAT }}
           publish_dir: ./allure-report
           publish_branch: gh-pages